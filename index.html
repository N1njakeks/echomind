<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EchoMind Cloud</title>
    
    <link rel="icon" href="https://api.dicebear.com/7.x/shapes/svg?seed=EchoMind&backgroundColor=4f46e5">
    <meta name="theme-color" content="#ffffff">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .prose p { margin-bottom: 0.5em; }
        .message-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .is-read { opacity: 0.6; background-color: #f8fafc; }
        .is-read:hover { opacity: 1; background-color: white; }
        .yt-thumbnail { aspect-ratio: 16/9; background-size: cover; background-position: center; border-radius: 0.5rem; margin-bottom: 0.75rem; }
        
        .citation-btn {
            display: inline-flex; align-items: center; gap: 4px;
            background-color: #e0e7ff; color: #4338ca;
            padding: 2px 8px; border-radius: 12px;
            font-size: 0.75em; font-weight: 600; cursor: pointer;
            transition: all 0.2s; vertical-align: baseline; border: 1px solid #c7d2fe;
            text-decoration: none !important; white-space: nowrap; margin: 0 2px;
        }
        .citation-btn:hover { background-color: #4338ca; color: white; transform: translateY(-1px); }
        .citation-btn::before { content: "\f02d"; font-family: "Font Awesome 6 Free"; font-weight: 900; }

        #sourceContent {
            background-color: #ffffff; color: #334155; font-family: 'Georgia', serif;
            line-height: 1.8; padding: 3rem; max-width: 100%; margin: 0 auto;
        }

        .page-marker {
            display: block; border-bottom: 2px solid #e2e8f0; margin: 4rem 0 2rem 0;
            padding-bottom: 0.5rem; font-family: sans-serif; font-weight: 700;
            color: #94a3b8; font-size: 0.8rem; text-transform: uppercase;
            letter-spacing: 0.1em; text-align: center; scroll-margin-top: 120px;
        }

        .highlight-section { animation: highlight-pulse 3s ease-out forwards; background-color: rgba(253, 224, 71, 0.3); }
        @keyframes highlight-pulse { 0% { background-color: rgba(253, 224, 71, 0.8); } 100% { background-color: transparent; } }
        
        .katex { font-size: 1.1em; }
        @media (max-width: 640px) { .mobile-hide { display: none; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <nav class="flex justify-between items-center px-6 py-4 bg-white border-b border-slate-200 sticky top-0 z-10 shadow-sm">
        <div class="flex items-center gap-2 cursor-pointer" onclick="location.reload()">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold shadow-indigo-200 shadow-lg">E</div>
            <span class="font-semibold text-lg tracking-tight hidden sm:inline">EchoMind</span>
        </div>
        <div class="flex items-center gap-3">
            <div id="userInfo" class="text-xs font-medium text-slate-500 hidden sm:block"></div>
            <button onclick="app.logout()" class="text-xs text-slate-400 hover:text-red-600 transition border border-slate-200 rounded px-2 py-1" title="Sign Out">
                <i class="fa-solid fa-right-from-bracket"></i>
            </button>
        </div>
    </nav>

    <main class="flex-grow flex flex-col items-center px-4 pt-8 pb-36 max-w-5xl mx-auto w-full">
        
        <div class="w-full mb-8 flex flex-wrap justify-between items-end gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Your Library</h1>
                <p class="text-slate-500 text-sm">Private cloud storage & AI analysis.</p>
            </div>
            <div class="flex gap-2">
                <input type="file" id="pdfInput" accept=".pdf" class="hidden">
                <button onclick="app.viewDatabase()" class="text-xs font-medium text-slate-600 bg-white hover:bg-slate-50 px-3 py-2 rounded-lg transition shadow-sm border border-slate-200">
                    <i class="fa-solid fa-list"></i> List
                </button>
                <button onclick="document.getElementById('pdfInput').click()" class="text-xs font-medium text-white bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg transition flex items-center gap-2 shadow-sm shadow-indigo-200 hover:shadow-indigo-300">
                    <i class="fa-solid fa-plus"></i> PDF Upload
                </button>
            </div>
        </div>

        <div class="w-full grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
            <button onclick="app.openList('unread')" class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md hover:border-indigo-200 transition text-left group relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fa-regular fa-bookmark text-6xl text-indigo-600"></i></div>
                <h3 class="font-bold text-lg text-slate-800">Inbox (Unread)</h3>
                <p class="text-sm text-slate-500 mt-1">New sources via extension or upload.</p>
                <div class="mt-4 text-xs font-bold bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full w-fit" id="countUnread">0 Sources</div>
            </button>

            <button onclick="app.openList('read')" class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md hover:border-emerald-200 transition text-left group relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-book-open text-6xl text-emerald-600"></i></div>
                <h3 class="font-bold text-lg text-slate-800">Notebook (Read)</h3>
                <p class="text-sm text-slate-500 mt-1">Ready for Deep Dive & Quiz.</p>
                <div class="mt-4 text-xs font-bold bg-emerald-50 text-emerald-700 px-3 py-1 rounded-full w-fit" id="countRead">0 Sources</div>
            </button>
        </div>

        <div class="w-full mb-10">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wider">Deep Dive</h2>
                <button onclick="app.loadDashboard()" class="text-xs text-slate-400 hover:text-indigo-600 transition"><i class="fa-solid fa-rotate"></i> Shuffle</button>
            </div>
            <div id="cardsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            <div id="emptyState" class="hidden w-full py-12 text-center bg-white rounded-2xl border border-dashed border-slate-200">
                <p class="text-slate-500 font-medium">Notebook empty.</p>
            </div>
        </div>
        
        <div id="chatContainer" class="w-full flex flex-col gap-6 mb-4"></div>
    </main>

    <footer class="fixed bottom-0 left-0 w-full bg-white border-t border-slate-200 p-4 z-20">
        <div class="max-w-3xl mx-auto relative">
            <div id="contextBar" class="hidden absolute -top-10 left-0 right-0 flex justify-between items-center bg-indigo-50 border border-indigo-100 text-indigo-700 px-3 py-1.5 rounded-t-lg text-xs font-medium shadow-sm">
                <span class="truncate max-w-[85%] flex items-center"><i class="fa-solid fa-link mr-2"></i>Chatting with: <span id="contextName" class="font-bold ml-1">...</span></span>
                <button onclick="app.clearContext()" class="hover:text-indigo-900 p-1"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="flex gap-2">
                <textarea id="mainInput" rows="1" class="flex-grow p-3 bg-slate-100 border-none rounded-xl focus:ring-2 focus:ring-indigo-500 resize-none text-slate-800 placeholder-slate-400 text-sm" placeholder="Ask a question..."></textarea>
                <button id="sendBtn" class="w-12 h-12 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl flex items-center justify-center transition-colors"><i class="fa-solid fa-arrow-up text-sm"></i></button>
            </div>
        </div>
    </footer>

    <div id="authModal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl max-w-sm w-full shadow-2xl text-center relative animate-fade-in">
            <div class="w-12 h-12 bg-indigo-600 text-white rounded-xl flex items-center justify-center mx-auto mb-4 text-xl font-bold">E</div>
            <h2 class="text-xl font-bold text-slate-800 mb-1">Welcome back</h2>
            <p class="text-sm text-slate-500 mb-6">Sign in to access your cloud library.</p>
            <input type="email" id="emailInput" class="w-full p-3 border border-slate-300 rounded-lg mb-3 text-sm outline-none" placeholder="Email">
            <input type="password" id="passwordInput" class="w-full p-3 border border-slate-300 rounded-lg mb-6 text-sm outline-none" placeholder="Password">
            <div class="flex flex-col gap-3">
                <button onclick="app.login()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition shadow-lg shadow-indigo-200">Sign In</button>
                <button onclick="app.signup()" class="w-full bg-white border border-slate-200 text-slate-600 py-3 rounded-lg font-medium hover:bg-slate-50 transition">Create Account</button>
            </div>
            <div id="authError" class="text-red-500 text-xs mt-4 hidden"></div>
        </div>
    </div>

    <div id="listModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden backdrop-blur-sm">
        <div class="bg-white w-full max-w-3xl max-h-[85vh] rounded-2xl p-0 flex flex-col shadow-2xl overflow-hidden animate-fade-in">
            <div class="flex justify-between items-center p-6 border-b border-slate-100 bg-white z-10">
                <div><h3 class="font-bold text-xl text-slate-800" id="listTitle">List</h3><p class="text-xs text-slate-500 mt-1" id="listSubtitle">Cloud Data</p></div>
                <button onclick="document.getElementById('listModal').classList.add('hidden'); app.loadDashboard();" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto bg-slate-50 p-6"><div id="listContent" class="space-y-3"></div></div>
        </div>
    </div>

    <div id="sourceModal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden backdrop-blur-sm">
        <div class="bg-white w-full max-w-3xl h-[90vh] rounded-2xl flex flex-col shadow-2xl animate-fade-in m-4 overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-slate-100 bg-white z-10">
                <div>
                    <h3 class="font-bold text-lg text-slate-800 truncate max-w-xs" id="sourceTitle">Source</h3>
                    <p class="text-xs text-emerald-600 font-medium" id="sourcePage"><i class="fa-solid fa-location-dot mr-1"></i>Locating...</p>
                </div>
                <button onclick="document.getElementById('sourceModal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto p-8 bg-slate-50 scroll-smooth text-slate-700" id="sourceContent"></div>
        </div>
    </div>

    <script>
        class APIClient {
            async request(endpoint, method = 'GET', body = null) {
                const options = { method, headers: { 'Content-Type': 'application/json' } };
                if (body) options.body = JSON.stringify(body);
                const response = await fetch(`/api/${endpoint}`, options);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'API Error');
                }
                return response.json();
            }
        }

        class DashboardApp {
            constructor() {
                this.api = new APIClient();
                this.currentData = [];
                this.user = null;
                this.activeCitationItem = null;
                
                this.dom = {
                    input: document.getElementById('mainInput'),
                    chat: document.getElementById('chatContainer'),
                    cards: document.getElementById('cardsContainer'),
                    emptyState: document.getElementById('emptyState'),
                    pdfInput: document.getElementById('pdfInput'),
                    authModal: document.getElementById('authModal'),
                    emailInput: document.getElementById('emailInput'),
                    passInput: document.getElementById('passwordInput'),
                    authError: document.getElementById('authError'),
                    userInfo: document.getElementById('userInfo'),
                    listModal: document.getElementById('listModal'),
                    listTitle: document.getElementById('listTitle'),
                    listContent: document.getElementById('listContent'),
                    countUnread: document.getElementById('countUnread'),
                    countRead: document.getElementById('countRead'),
                    sourceModal: document.getElementById('sourceModal'),
                    sourceTitle: document.getElementById('sourceTitle'),
                    sourcePage: document.getElementById('sourcePage'),
                    sourceContent: document.getElementById('sourceContent'),
                    contextBar: document.getElementById('contextBar'),
                    contextName: document.getElementById('contextName')
                };
                
                document.getElementById('sendBtn').onclick = () => this.handleInput();
                this.dom.input.onkeydown = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.handleInput(); } };
                this.dom.pdfInput.onchange = (e) => this.handlePdfUpload(e);
                
                this.checkSession();
            }

            async checkSession() {
                const storedUser = localStorage.getItem('echomind_user');
                if (storedUser) {
                    this.user = JSON.parse(storedUser);
                    this.onLoginSuccess(this.user);
                } else {
                    this.dom.authModal.classList.remove('hidden');
                }
            }

            async login() {
                const email = this.dom.emailInput.value.trim();
                const password = this.dom.passInput.value.trim();
                try {
                    const data = await this.api.request('auth/login', 'POST', { email, password });
                    this.user = data.user;
                    localStorage.setItem('echomind_user', JSON.stringify(this.user));
                    this.onLoginSuccess(this.user);
                } catch(e) {
                    this.dom.authError.innerText = "Failed: " + e.message;
                    this.dom.authError.classList.remove('hidden');
                }
            }

            async signup() {
                const email = this.dom.emailInput.value.trim();
                const password = this.dom.passInput.value.trim();
                try {
                    await this.api.request('auth/signup', 'POST', { email, password });
                    alert("Account created! Please check email.");
                } catch(e) {
                    this.dom.authError.innerText = "Error: " + e.message;
                    this.dom.authError.classList.remove('hidden');
                }
            }

            logout() { localStorage.removeItem('echomind_user'); location.reload(); }

            onLoginSuccess(user) {
                this.dom.authModal.classList.add('hidden');
                this.dom.userInfo.innerText = user.email;
                this.loadDashboard();
            }

            async loadDashboard() { 
                try {
                    const data = await this.api.request(`items?user_id=${this.user.id}`);
                    this.currentData = data;
                    const unread = this.currentData.filter(i => !i.is_read);
                    const read = this.currentData.filter(i => i.is_read);
                    this.dom.countUnread.innerText = `${unread.length} Sources`;
                    this.dom.countRead.innerText = `${read.length} Sources`;
                    if (read.length === 0 && unread.length === 0) this.dom.emptyState.classList.remove('hidden');
                    else {
                        this.dom.emptyState.classList.add('hidden');
                        if (read.length > 0) this.renderCards(read.sort(() => 0.5 - Math.random()).slice(0, 6)); 
                        else this.renderCards([]); 
                    }
                } catch(e) { console.error("Error loading dashboard:", e); }
            }

            async handlePdfUpload(event) { 
                const file = event.target.files[0]; 
                if(!file) return; 
                this.addBubble("Processing PDF...", true);
                try { 
                    const p = await pdfjsLib.getDocument({data:new Uint8Array(await file.arrayBuffer())}).promise; 
                    let fullText = `SOURCE: ${file.name}\nTYPE: PDF Document\n\n`; 
                    for(let i=1; i<=p.numPages; i++) {
                        const page = await p.getPage(i);
                        const content = await page.getTextContent();
                        const strings = content.items.map(s => s.str).join(' ');
                        fullText += `\n\n[[PAGE ${i}]]\n${strings}`; 
                    }
                    await this.api.request('save-item', 'POST', { user_id: this.user.id, topic: file.name.replace('.pdf',''), full_text: fullText, is_pdf: true });
                    this.loadDashboard(); 
                    this.addBubble(`âœ… Added PDF (${p.numPages} pages) & indexed.`, false); 
                } catch(e){ 
                    console.error(e); this.addBubble("âŒ PDF Error: " + e.message, false); 
                } 
            }

            async handleInput(t=null){
                const text = t || this.dom.input.value.trim(); 
                if(!text) return; 
                if(!t) this.dom.input.value=''; 
                this.addBubble(text, true);
                this.showLoading(true);
                try {
                    // Calls the Vercel API for RAG Chat
                    const response = await this.api.request('chat', 'POST', {
                        query: text,
                        user_id: this.user.id,
                        context_item_id: this.activeCitationItem ? this.activeCitationItem.id : null
                    });
                    this.showLoading(false);
                    if (response.quizJSON) this.renderQuiz(response.quizJSON);
                    else this.addBubble(response.answer, false);
                } catch(e) {
                    this.showLoading(false);
                    this.addBubble("âŒ Error: " + e.message, false);
                }
            }

            async aiAction(id, type) {
                this.activeCitationItem = this.currentData.find(i => i.id === id);
                await this.handleInput(type === 'summary' ? "Summarize this document" : "Create a quiz for this document");
            }

            addBubble(text, isUser) {
                const d = document.createElement('div');
                d.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} message-enter`;
                let html = isUser ? text : marked.parse(text);
                if(!isUser) html = html.replace(/(?:\[+|\[|\(|^|\s)Page\s*(\d+)(?:\]+|\)|\]|\.|,|$)/gi, ` <button class="citation-btn" onclick="app.openSourceContext($1)">Page $1</button> `);
                d.innerHTML = `<div class="${isUser?'bg-slate-100':'prose prose-slate'} px-4 py-2 rounded-lg max-w-[85%] shadow-sm border border-slate-100">${html}</div>`;
                this.dom.chat.appendChild(d);
                this.dom.chat.scrollTop = this.dom.chat.scrollHeight;
            }

            renderQuiz(d){
                const v=document.createElement('div'); v.className="flex gap-4 w-full message-enter";
                const qHtml = marked.parse(d.question);
                v.innerHTML=`<div class="w-full max-w-md bg-white border rounded-xl p-4 shadow-sm"><div class="font-bold text-sm mb-4 prose prose-slate">${qHtml}</div><div id="opts" class="space-y-2"></div><div id="res" class="hidden mt-4 text-sm p-3 bg-slate-50 rounded-lg border border-slate-100"></div></div>`;
                const o=v.querySelector('#opts');
                d.options.forEach((opt,i)=>{
                    const b=document.createElement('button');
                    b.className="w-full text-left text-sm p-3 border border-slate-200 rounded-xl hover:bg-slate-50 transition-all";
                    b.innerHTML = marked.parseInline(opt);
                    b.onclick=()=>{
                        const allBtns = o.querySelectorAll('button'); allBtns.forEach(btn => btn.disabled = true);
                        const isCorrect = i===d.correctIndex;
                        b.className = isCorrect ? "w-full text-left text-sm p-3 border border-emerald-500 bg-emerald-50 text-emerald-700 rounded-xl font-medium shadow-sm" : "w-full text-left text-sm p-3 border border-red-500 bg-red-50 text-red-700 rounded-xl";
                        if(!isCorrect && allBtns[d.correctIndex]) allBtns[d.correctIndex].className = "w-full text-left text-sm p-3 border border-emerald-500 bg-emerald-50 text-emerald-700 rounded-xl font-medium";
                        const resDiv = v.querySelector('#res');
                        resDiv.innerHTML=(isCorrect?"<div class='text-emerald-600 font-bold mb-2'>Correct! ðŸŽ‰</div>":"<div class='text-red-600 font-bold mb-2'>Incorrect</div>")+`<div class="prose prose-sm text-slate-600">${marked.parse(d.explanation)}</div>`;
                        resDiv.classList.remove('hidden');
                    };
                    o.appendChild(b);
                });
                this.dom.chat.appendChild(v);
                this.dom.chat.scrollTop=this.dom.chat.scrollHeight;
            }

            showLoading(s){ const e=document.getElementById('loader'); if(e) e.remove(); if(s){ const d=document.createElement('div'); d.id='loader'; d.innerHTML='<div class="flex gap-2 p-4"><div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay:0.1s"></div></div>'; this.dom.chat.appendChild(d); }}
            openList(type) { const data = type === 'unread' ? this.currentData.filter(i => !i.is_read) : this.currentData.filter(i => i.is_read); this.dom.listModal.querySelector('#listTitle').innerText = type === 'unread' ? "Inbox" : "Notebook"; this.renderList(data, type); this.dom.listModal.classList.remove('hidden'); }
            renderList(data, type) { if(data.length===0) { this.dom.listContent.innerHTML='<div class="text-center py-10 text-slate-400">Empty.</div>'; return; } this.dom.listContent.innerHTML = data.map(i => { const date = new Date(i.timestamp).toLocaleDateString(); const btn = type==='unread' ? `<button onclick="app.toggleRead(${i.id})" class="bg-indigo-600 text-white px-3 py-1 rounded text-xs hover:bg-indigo-700">Read</button>` : `<button class="border border-slate-300 text-slate-500 px-3 py-1 rounded text-xs">Read</button>`; const ai = type==='read' ? `<button onclick="app.setContext(${i.id})" class="bg-indigo-50 text-indigo-600 px-2 py-1 rounded text-xs mr-2 font-bold">Chat</button> <button onclick="app.closeAndAsk(${i.id},'summary')" class="bg-slate-100 px-2 py-1 rounded text-xs mr-2">Summary</button> <button onclick="app.closeAndAsk(${i.id},'quiz')" class="bg-amber-50 px-2 py-1 rounded text-xs text-amber-600">Quiz</button>` : ''; return `<div class="bg-white p-4 rounded border border-slate-100 flex justify-between items-start mb-2"><div class="flex-grow"><h4 class="font-bold text-slate-800">${i.topic}</h4><div class="text-xs text-slate-400 mt-1">${date}</div><div class="mt-2">${ai}</div></div><div class="flex flex-col gap-2 items-end">${btn}<button onclick="app.deleteItem(${i.id})" class="text-red-400 text-xs"><i class="fa-solid fa-trash"></i></button></div></div>`; }).join(''); }
            renderCards(data) { this.dom.cards.innerHTML = data.map(i => { const icon = i.is_pdf ? "fa-solid fa-file-pdf" : "fa-solid fa-file-lines"; return `<div class="p-4 rounded-xl border border-slate-200 bg-white hover:shadow-md transition flex flex-col h-full"><div class="flex justify-between mb-3"><div class="w-8 h-8 rounded bg-indigo-50 text-indigo-600 flex items-center justify-center"><i class="${icon}"></i></div></div><h3 class="font-bold text-sm mb-1 line-clamp-2" title="${i.topic}">${i.topic}</h3><div class="flex gap-2 mt-auto pt-3 border-t"><button onclick="app.setContext(${i.id})" class="flex-grow text-[10px] bg-indigo-50 hover:bg-indigo-100 text-indigo-600 py-1.5 rounded font-bold"><i class="fa-regular fa-comments mr-1"></i> Chat</button></div></div>`; }).join(''); }
            
            async toggleRead(id) { await this.api.request('save-item', 'POST', { id, is_read: true, user_id: this.user.id, update_only: true }); this.loadDashboard(); this.dom.listModal.classList.add('hidden'); }
            async deleteItem(id) { if(confirm("Delete?")) { await this.api.request('items', 'DELETE', { id, user_id: this.user.id }); this.loadDashboard(); this.dom.listModal.classList.add('hidden'); } }
            async closeAndAsk(id, type) { this.dom.listModal.classList.add('hidden'); await this.aiAction(id, type); }
            
            setContext(id) { const item = this.currentData.find(i => i.id === id); if (item) { this.activeCitationItem = item; this.dom.contextName.innerText = item.topic; this.dom.contextBar.classList.remove('hidden'); this.dom.listModal.classList.add('hidden'); } }
            clearContext() { this.activeCitationItem = null; this.dom.contextBar.classList.add('hidden'); }
            openSourceContext(pageNum) { if (!this.activeCitationItem) return; const item = this.activeCitationItem; this.dom.sourceTitle.innerText = item.topic; this.dom.sourcePage.innerText = `Locating Page ${pageNum}...`; this.dom.sourceContent.innerHTML = '<div class="text-center p-10 text-slate-400"><i class="fa-solid fa-circle-notch fa-spin mr-2"></i>Rendering Document...</div>'; this.dom.sourceModal.classList.remove('hidden'); setTimeout(() => { let rawHtml = item.full_text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>'); rawHtml = rawHtml.replace(/\[\[\s*PAGE\s*(\d+)\s*\]\]/gi, '<div id="page-$1" class="page-marker">--- PAGE $1 ---</div>'); this.dom.sourceContent.innerHTML = rawHtml; setTimeout(() => { const element = document.getElementById(`page-${pageNum}`); if (element) { element.scrollIntoView({ behavior: 'auto', block: 'start' }); element.classList.add('highlight-section'); this.dom.sourcePage.innerText = `Page ${pageNum}`; } else { this.dom.sourcePage.innerText = `Page ${pageNum} not found`; } }, 500); }, 50); }
            viewDatabase() { this.openList('read'); }
        }
        window.app = new DashboardApp();
    </script>
</body>
</html>